{"paragraphs":[{"text":"%md # Running SQL Queries in Spark\n## Extracting the Origin-Destination Matrix","user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/markdown","fontSize":9,"editorHide":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<div class=\"markdown-body\">\n<h1>Running SQL Queries in Spark</h1>\n<h2>Extracting the Origin-Destination Matrix</h2>\n</div>"}]},"apps":[],"jobName":"paragraph_1611185077366_-196899011","id":"20201203-021624_1056647944","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:60"},{"text":"%sql\n-- This Source Code Form is subject to the terms of the Mozilla Public\n-- License, v. 2.0. If a copy of the MPL was not distributed with this\n-- file, You can obtain one at http://mozilla.org/MPL/2.0/.\n\nCREATE TABLE od_matrix_directed_consecutive_pairs_per_day\n  AS WITH located AS (SELECT msisdn,\n                             locality,\n                             call_date,\n                             row_number() OVER (PARTITION BY msisdn, call_date\n                                                ORDER BY call_datetime ASC) AS rank\n                      FROM calls\n                           INNER JOIN cells ON calls.location_id = cells.cell_id\n                      WHERE (calls.call_date >= '2020-02-01')\n                        AND (calls.call_date <= CURRENT_DATE))\n\n       SELECT call_date,\n              locality_from,\n              locality_to,\n              count(*)\n       FROM (SELECT source.msisdn,\n                    source.call_date,\n                    source.locality AS locality_from,\n                    sink.locality AS locality_to\n             FROM located AS source\n                  INNER JOIN (SELECT msisdn,\n                                     locality,\n                                     call_date,\n                                     rank - 1 AS rank\n                              FROM located) AS sink USING (msisdn, call_date, rank)\n             GROUP BY msisdn, call_date, locality_from, locality_to) AS joined\n       GROUP BY call_date, locality_from, locality_to\n       HAVING count(*) > 15; \n","user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":6,"editorMode":"ace/mode/sql","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611185077367_-700940669","id":"20201207-194122_1586112953","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:61"},{"text":"\n\nval odMatrixDirectedConsecutivePairsPerDay = spark.sql(s\"\"\"\n    WITH located AS (SELECT msisdn,\n                             locality,\n                             call_date,\n                             row_number() OVER (PARTITION BY msisdn, call_date\n                                                ORDER BY call_datetime ASC) AS rank\n                      FROM calls\n                           INNER JOIN cells ON calls.site_id = cells.site_id\n                      WHERE (calls.call_date >= '2020-02-01')\n                        AND (calls.call_date <= CURRENT_DATE))\n\n       SELECT call_date,\n              locality_from,\n              locality_to,\n              count(*)\n       FROM (SELECT source.msisdn,\n                    source.call_date,\n                    source.locality AS locality_from,\n                    sink.locality AS locality_to\n             FROM located AS source\n                  INNER JOIN (SELECT msisdn,\n                                     locality,\n                                     call_date,\n                                     rank - 1 AS rank\n                              FROM located) AS sink USING (msisdn, call_date, rank)\n             GROUP BY msisdn, call_date, locality_from, locality_to) AS joined\n       GROUP BY call_date, locality_from, locality_to\n       HAVING count(*) > 15 \n\"\"\")\nodMatrixDirectedConsecutivePairsPerDay.createOrReplaceTempView(\"od_matrix_directed_consecutive_pairs_per_day\")","user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":6,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"odMatrixDirectedConsecutivePairsPerDay: org.apache.spark.sql.DataFrame = [call_date: date, locality_from: string ... 2 more fields]\n"}]},"apps":[],"jobName":"paragraph_1611185077367_-653561462","id":"20200706-023816_1473159979","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:62"},{"text":"%spark.sql\nselect * from od_matrix_directed_consecutive_pairs_per_day","user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"editorSetting":{"language":"sql","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/sql","fontSize":9,"results":{"0":{"graph":{"mode":"table","height":300,"optionOpen":false,"setting":{"table":{"tableGridState":{},"tableColumnTypeState":{"names":{"call_date":"string","locality_from":"string","locality_to":"string","count(1)":"string"},"updated":false},"tableOptionSpecHash":"[{\"name\":\"useFilter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable filter for columns\"},{\"name\":\"showPagination\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable pagination for better navigation\"},{\"name\":\"showAggregationFooter\",\"valueType\":\"boolean\",\"defaultValue\":false,\"widget\":\"checkbox\",\"description\":\"Enable a footer for displaying aggregated values\"}]","tableOptionValue":{"useFilter":false,"showPagination":false,"showAggregationFooter":false},"updated":false,"initialized":false}},"commonSetting":{}}}},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TABLE","data":"call_date\tlocality_from\tlocality_to\tcount(1)\n"},{"type":"TEXT","data":""}]},"apps":[],"jobName":"paragraph_1611185077367_-1127909468","id":"20200706-024848_266901746","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:63"},{"text":"odMatrixDirectedConsecutivePairsPerDay.saveToS3(\"od_matrix_directed_consecutive_pairs_per_day\")","user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1611185077368_-1049587780","id":"20200706-024905_728820264","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:64"},{"user":"innocent","dateUpdated":"2021-01-20T23:24:37+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/scala","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611185077368_1519355024","id":"20200713-005018_1821058309","dateCreated":"2021-01-20T23:24:37+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:65"}],"name":"Training/6.Consecutive_Pairs_FL","id":"2FVGVFF3S","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}