{"paragraphs":[{"text":"%spark.pyspark\n\nimport os\nfrom datetime import datetime\n\nfrom pyspark.sql.types import StructType, StructField, StringType, IntegerType\nfrom pyspark.sql.functions import split, lower, when, lag, col\nimport pyspark.sql.functions as F\nfrom pyspark import StorageLevel\nfrom pyspark.sql.window import Window","user":"innocent","dateUpdated":"2021-01-20T23:47:14+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1611185064269_1817992826","id":"20201203-015424_578916751","dateCreated":"2021-01-20T23:24:24+0000","dateStarted":"2021-01-20T23:47:14+0000","dateFinished":"2021-01-20T23:47:14+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:29"},{"text":"%spark.pyspark\nname = \"innocent\"\nstops_path = \"s3n://sierra-leone-lake/training/data/cdrs/stops/{}_stops\".format(name)\noutput_path = \"s3n://sierra-leone-lake/training/data/cdrs/journeys/{}_journeys\".format(name)","user":"innocent","dateUpdated":"2021-01-20T23:47:17+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1611185064270_-1401675731","id":"20201203-015724_1925136200","dateCreated":"2021-01-20T23:24:24+0000","dateStarted":"2021-01-20T23:47:17+0000","dateFinished":"2021-01-20T23:47:17+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:30"},{"text":"%spark.pyspark\n#  not run yet\n\nnames={'msisdn':StringType(), 'site_id':StringType(), 'call_date':StringType(), 'STOP_ID':IntegerType(), 'start_time':StringType(), 'end_time':StringType(), 'frequency':IntegerType(), 'event_gap':IntegerType(), 'duration':IntegerType(), 'confidence': StringType()}\nfields=[]\n\nfor header in names:\n    fields.append(StructField(header, names[header], False))\nschema = StructType(fields)\n\nsubscriberDatetimeSpec = Window\\\n                            .partitionBy(['msisdn','call_datetime'])\\\n                            .orderBy(col('start_time'))","user":"innocent","dateUpdated":"2021-01-20T23:47:51+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1611185064270_-643712699","id":"20201203-015736_1273856079","dateCreated":"2021-01-20T23:24:24+0000","dateStarted":"2021-01-20T23:47:23+0000","dateFinished":"2021-01-20T23:47:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:31"},{"text":"%spark.pyspark\nstops = spark.read.option(\"header\", \"true\")\\\n        .csv(stops_path, schema=schema)\\\n\ndftrips = stops.withColumn(\"call_datetime\", F.to_date(\"call_date\"))\\\n        .withColumn(\"start_time\",F.to_timestamp(\"start_time\"))\\\n        .withColumn(\"morning\", when(F.hour(\"start_time\") > 12, True).otherwise(False))\\\n        .drop('call_date', 'end_time')\\\n        .withColumn(\"des_id\", lag(\"site_id\", -1).over(subscriberDatetimeSpec))\\\n        .na.drop()\\\n        .where(\"site_id != des_id\")\\\n        .groupBy([\"site_id\", \"des_id\", \"call_datetime\", \"morning\"])\\\n        .agg(F.sum(col(\"frequency\")))\n\ndftrips.coalesce(1).write\\\n    .format(\"csv\")\\\n    .mode(\"overwrite\")\\\n    .option(\"header\", \"true\")\\\n    .save(output_path)\n","user":"innocent","dateUpdated":"2021-01-20T23:47:56+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1611185064271_1094338137","id":"20201203-020042_705377664","dateCreated":"2021-01-20T23:24:24+0000","dateStarted":"2021-01-20T23:47:56+0000","dateFinished":"2021-01-20T23:48:08+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:32"},{"text":"%spark.pyspark\n","user":"innocent","dateUpdated":"2021-01-20T23:24:24+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+-------+-------+-------------------+---------+---------+--------+------------------+-------------+-------+------+\n|              msisdn|site_id|STOP_ID|         start_time|frequency|event_gap|duration|        confidence|call_datetime|morning|des_id|\n+--------------------+-------+-------+-------------------+---------+---------+--------+------------------+-------------+-------+------+\n|D12810665E022B219...|   1219|      1|2020-03-06 16:15:00|        3|     3596|    7204|0.4991671293725708|   2020-03-06|   true|  null|\n|758AA59A38602EFF2...|   1224|      1|2020-03-13 17:15:00|        2|     3600|    3604|0.9988901220865705|   2020-03-13|   true|  null|\n|BD8E47524A232748A...|   2209|      1|2020-03-11 13:15:00|        2|     3600|    3605|0.9986130374479889|   2020-03-11|   true|  null|\n|6D01C2874449429E2...|   2033|      1|2020-03-10 13:15:00|        2|     3600|    3620| 0.994475138121547|   2020-03-10|   true|  null|\n|072BD3EC268998D40...|   2079|      1|2020-03-08 20:15:00|        2|     3596|    3606|0.9972268441486412|   2020-03-08|   true|  null|\n|5BEA0EC35AC80ADC3...|   2047|      1|2020-03-13 11:15:00|        2|     3592|    3628|0.9900771775082691|   2020-03-13|  false|  null|\n|D00001B0A361A55A7...|   2222|      1|2020-03-10 06:15:00|        2|     3586|    3611| 0.993076710052617|   2020-03-10|  false|  null|\n|6F881DED296F2D06F...|   1220|      1|2020-03-12 01:15:00|        2|     3052|    3629|0.8410030311380545|   2020-03-12|  false|  null|\n|8AF00944C45AF6791...|   2207|      1|2020-03-08 01:15:00|        2|     3574|    3649|  0.97944642367772|   2020-03-08|  false|  null|\n|D4A76E796FC2251D9...|   2035|      1|2020-03-12 03:15:00|        2|     3491|    3646|0.9574876577070762|   2020-03-12|  false|  null|\n|B2A2B5104FAC2BF70...|   4032|      1|2020-03-13 00:15:00|        3|     3596|    7204|0.4991671293725708|   2020-03-13|  false|  null|\n|F8454C6C2D943DD56...|   3565|      1|2020-03-13 21:15:00|        2|     3586|    3610|0.9933518005540166|   2020-03-13|   true|  null|\n|AC9C41B885BEF45F4...|   4016|      1|2020-03-09 02:15:00|        2|     3571|    3601| 0.991668980838656|   2020-03-09|  false|  null|\n|59E64612430E0E2B9...|   1038|      1|2020-03-05 19:15:00|        3|     3596|    7204|0.4991671293725708|   2020-03-05|   true|  null|\n|F265BE84C4B15C94F...|   2026|      1|2020-03-08 01:15:00|        2|     3569|    3604|0.9902885682574917|   2020-03-08|  false|  null|\n|9D414DECEFAE2ECE4...|   1014|      1|2020-03-12 06:15:00|        2|     3511|    3617|0.9706939452585015|   2020-03-12|  false|  null|\n|B67B5085B05238998...|   1434|      1|2020-03-07 04:15:00|        2|     3596|    3604|0.9977802441731409|   2020-03-07|  false|  null|\n|3F12035DD36F2E85F...|   2034|      1|2020-03-12 06:15:00|        2|     3597|    3600|0.9991666666666666|   2020-03-12|  false|  null|\n|E90BDD0846E1FDF72...|   3442|      1|2020-03-08 22:15:00|        2|     3593|    3604|0.9969478357380688|   2020-03-08|   true|  null|\n|F824F274FF2A1A65B...|   3508|      1|2020-03-06 21:15:00|        2|     3561|    3604|0.9880688124306326|   2020-03-06|   true|  null|\n+--------------------+-------+-------+-------------------+---------+---------+--------+------------------+-------------+-------+------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1611185064271_1985295204","id":"20201203-230524_1428009251","dateCreated":"2021-01-20T23:24:24+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:33"},{"text":"%spark.pyspark\n","user":"innocent","dateUpdated":"2021-01-20T23:24:24+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false,"completionKey":"TAB","completionSupport":true},"colWidth":12,"editorMode":"ace/mode/python","fontSize":9,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1611185064272_1516226792","id":"20210120-202620_118458211","dateCreated":"2021-01-20T23:24:24+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:34"}],"name":"Training/4.Generate_Journeys","id":"2FYBSQ81D","noteParams":{},"noteForms":{},"angularObjects":{"md:shared_process":[],"python:shared_process":[],"sh:shared_process":[],"spark:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":false,"looknfeel":"default","personalizedMode":"false"},"info":{}}